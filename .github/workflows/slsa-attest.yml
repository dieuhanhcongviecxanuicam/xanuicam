name: SLSA provenance & attestation (cosign keyless example)

on:
  push:
    branches: [ 'main' ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-push-and-attest:
    name: Build images, push to GHCR, and produce SLSA attestation (cosign keyless)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Repo diagnostic
        run: |
          echo "PWD: $(pwd)"
          echo "Top-level files:"
          ls -la || true
          echo "backend exists:"; ls -la backend || true
          echo "frontend exists:"; ls -la frontend || true

      - name: Set up QEMU and Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/xanuicam-backend:${{ github.sha }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: frontend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/xanuicam-frontend:${{ github.sha }}


      - name: Install cosign (robust)
        run: |
          set -euxo pipefail
          if command -v cosign >/dev/null 2>&1; then
            echo "cosign already installed: $(cosign version || true)"
            exit 0
          fi

          TMP_BIN="/tmp/cosign.$$"
          try=0
          until [ $try -ge 4 ]
          do
            try=$((try+1))
            echo "Attempt $try to download cosign"
            # Prefer gh release download when available, else curl with redirects
            if command -v gh >/dev/null 2>&1; then
              gh release download -R sigstore/cosign -p 'cosign-linux-amd64' --pattern 'cosign-linux-amd64' -q -D /tmp || true
              if [ -f /tmp/cosign-linux-amd64 ]; then mv /tmp/cosign-linux-amd64 "$TMP_BIN"; fi
            fi

            if [ ! -f "$TMP_BIN" ]; then
              curl -fL -o "$TMP_BIN" "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64" || true
            fi

            if [ -f "$TMP_BIN" ]; then
              # Quick sanity: ensure it's an ELF binary and not HTML
              if file "$TMP_BIN" | grep -qi 'ELF\|executable'; then
                chmod +x "$TMP_BIN"
                sudo mv "$TMP_BIN" /usr/local/bin/cosign
                echo "Installed /usr/local/bin/cosign"
                break
              else
                echo "Downloaded file is not a binary, removing and retrying"
                rm -f "$TMP_BIN"
              fi
            fi

            sleep $((try * 2))
          done

          if ! command -v cosign >/dev/null 2>&1; then
            echo "cosign install failed after retries" >&2
            ls -la /tmp || true
            curl -vI "https://github.com/sigstore/cosign/releases/latest" || true
            exit 2
          fi

          cosign version || true

      - name: Workspace & image diagnostics before signing
        run: |
          set -eux
          echo "Workspace top-level:"; ls -la || true
          echo "Check backend image manifest (will try to pull)"
          docker --version || true
          for image in "ghcr.io/${{ github.repository_owner }}/xanuicam-backend:${{ github.sha }}" "ghcr.io/${{ github.repository_owner }}/xanuicam-frontend:${{ github.sha }}"; do
            echo "Inspecting: $image"
            docker pull "$image" || docker manifest inspect "$image" || true
          done


      - name: Sign backend image (try keyless, fallback to ephemeral key)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euxo pipefail
          IMAGE=ghcr.io/${{ github.repository_owner }}/xanuicam-backend:${{ github.sha }}
          # Prefer keyless when supported
          if cosign sign --help 2>&1 | grep -q -- '--keyless'; then
            echo "Attempting keyless sign"
            cosign sign --output-signature signature-backend.sig --output-certificate cert-backend.pem --keyless "$IMAGE"
          else
            echo "--keyless unsupported; generating ephemeral keypair and signing"
            rm -f cosign.key cosign.pub || true
            cosign generate-key-pair cosign || true
            cosign sign --key cosign.key --output-signature signature-backend.sig --output-certificate cert-backend.pem "$IMAGE"
          fi

      - name: List generated signing files after backend sign
        run: |
          set -eux
          ls -la signature-backend.sig cert-backend.pem || true


      - name: Sign frontend image (try keyless, fallback to ephemeral key)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euxo pipefail
          IMAGE=ghcr.io/${{ github.repository_owner }}/xanuicam-frontend:${{ github.sha }}
          if cosign sign --help 2>&1 | grep -q -- '--keyless'; then
            echo "Attempting keyless sign"
            cosign sign --output-signature signature-frontend.sig --output-certificate cert-frontend.pem --keyless "$IMAGE"
          else
            echo "--keyless unsupported; generating ephemeral keypair and signing"
            rm -f cosign.key cosign.pub || true
            cosign generate-key-pair cosign || true
            cosign sign --key cosign.key --output-signature signature-frontend.sig --output-certificate cert-frontend.pem "$IMAGE"
          fi

      - name: List generated signing files after frontend sign
        run: |
          set -eux
          ls -la signature-frontend.sig cert-frontend.pem || true

      - name: Upload attestations & provenance
        uses: actions/upload-artifact@v4
        with:
          name: slsa-attestations-${{ github.sha }}
          path: |
            signature-backend.sig
            cert-backend.pem
            signature-frontend.sig
            cert-frontend.pem
