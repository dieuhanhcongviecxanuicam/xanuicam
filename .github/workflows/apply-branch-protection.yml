name: Apply branch protection (requires secret)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  protect-main:
    name: Apply branch protection to `main`
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no code changes)
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Octokit
        run: npm ci @octokit/rest@19 --no-audit --no-fund

      - name: Apply branch protection via GitHub API
        env:
          PAT_REPO_HOOK: ${{ secrets.PAT_REPO_HOOK }}
          REPO: ${{ github.repository }}
        run: |
          node -e "
          const { Octokit } = require('@octokit/rest');
          const token = process.env.PAT_REPO_HOOK;
          if (!token) { console.error('Secret PAT_REPO_HOOK not set'); process.exit(2); }
          const [owner, repo] = process.env.REPO.split('/');
          const oct = new Octokit({ auth: token });
          (async () => {
            try {
              await oct.repos.updateBranchProtection({
                owner,
                repo,
                branch: 'main',
                required_status_checks: {
                  strict: true,
                  contexts: [ 'backend-tests', 'frontend-build', 'secret-scan' ]
                },
                enforce_admins: true,
                required_pull_request_reviews: {
                  dismissal_restrictions: {},
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false,
                  required_approving_review_count: 1
                },
                restrictions: null
              });
              console.log('Branch protection applied to main');
            } catch (err) {
              console.error('Failed to apply branch protection:', err);
              process.exit(3);
            }
          })();
          "

      - name: Done
        run: echo "Branch protection workflow finished. Verify settings in repo settings > Branches."

# SECURITY: This workflow requires a repository secret named `PAT_REPO_HOOK`.
# Do NOT commit personal access tokens into the repository. Add the token via
# GitHub UI: Settings -> Secrets and variables -> Actions -> New repository secret.