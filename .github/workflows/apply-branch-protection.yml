name: Apply branch protection (requires secret)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  protect-main:
    name: Apply branch protection to `main`
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no code changes)
        uses: actions/checkout@v4
        env:
          PAT_REPO_HOOK: ${{ secrets.PAT_REPO_HOOK }}
          REPO: ${{ github.repository }}
        run: |
            echo "Secret PAT_REPO_HOOK not set"
            exit 2
          fi
          OWNER=${REPO%%/*}
          REPO_NAME=${REPO#*/}
{
  "required_status_checks": {
    "strict": true,
    "contexts": [ "backend-tests", "frontend-build", "secret-scan" ]
  },
  "enforce_admins": true,
  "required_pull_request_reviews": {
    "dismiss_stale_reviews": true,
    "require_code_owner_reviews": false,
    "required_approving_review_count": 1
  },
  "restrictions": null
}
JSON
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PAT_REPO_HOOK" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$OWNER/$REPO_NAME/branches/main/protection \

# SECURITY: This workflow requires a repository secret named `PAT_REPO_HOOK`.
# Do NOT commit personal access tokens into the repository. Add the token via
# GitHub UI: Settings -> Secrets and variables -> Actions -> New repository secret.
