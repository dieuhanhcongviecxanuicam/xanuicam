name: Apply branch protection (requires secret)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  protect-main:
    name: Apply branch protection to `main`
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no code changes)
        uses: actions/checkout@v4

      - name: Apply branch protection via GitHub REST API (robust curl)
        env:
          PAT_REPO_HOOK: ${{ secrets.PAT_REPO_HOOK }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if [ -z "${PAT_REPO_HOOK:-}" ]; then
            echo "Secret PAT_REPO_HOOK not set"
            exit 2
          fi
          OWNER=${REPO%%/*}
          REPO_NAME=${REPO#*/}

          # Detect owner type (User or Organization). Use python3 which is available on runners.
          owner_type=$(curl -sS -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PAT_REPO_HOOK" \
            https://api.github.com/repos/$OWNER/$REPO_NAME | python3 -c 'import sys,json;print(json.load(sys.stdin)["owner"]["type"])')

          echo "Repository owner type: $owner_type"

          # Build a safe payload that works for both user and org repos.
          cat > /tmp/protect_payload.json <<'JSON'
{
  "required_status_checks": {
    "strict": true,
    "contexts": [ "backend-tests", "frontend-build", "secret-scan" ]
  },
  "enforce_admins": true,
  "required_pull_request_reviews": {
    "dismiss_stale_reviews": true,
    "require_code_owner_reviews": false,
    "required_approving_review_count": 1
  },
  "restrictions": null
}
JSON

          # Apply branch protection. If API returns non-2xx, print response and fail.
          resp_file=/tmp/protect_response.json
          http_status=$(curl -sS -w "%{http_code}" -o "$resp_file" -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PAT_REPO_HOOK" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$OWNER/$REPO_NAME/branches/main/protection \
            -d @/tmp/protect_payload.json)

          echo "HTTP status: $http_status"
          cat "$resp_file" | sed -n '1,240p'
          if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
            echo "Branch protection applied successfully."
          else
            echo "Failed to apply branch protection (HTTP $http_status). See response above."
            exit 3
          fi

# SECURITY: This workflow requires a repository secret named `PAT_REPO_HOOK`.
# Do NOT commit personal access tokens into the repository. Add the token via
# GitHub UI: Settings -> Secrets and variables -> Actions -> New repository secret.
